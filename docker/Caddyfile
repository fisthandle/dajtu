dajtu.com {
    encode gzip

    # Static images - served by Caddy with caching
    handle /i/* {
        root * /data/images
        file_server
        header Cache-Control "public, max-age=31536000, immutable"

        # Rewrite /i/abc123.webp to /ab/c1/abc123/original.webp
        # Rewrite /i/abc123/800.webp to /ab/c1/abc123/800.webp
        @original path_regexp original ^/i/([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{8})\.webp$
        rewrite @original /{re.original.1}/{re.original.2}/{re.original.1}{re.original.2}{re.original.3}/original.webp

        @sized path_regexp sized ^/i/([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{8})/(\d+)\.webp$
        rewrite @sized /{re.sized.1}/{re.sized.2}/{re.sized.1}{re.sized.2}{re.sized.3}/{re.sized.4}.webp
    }

    # API and gallery pages - proxy to Go app
    handle {
        reverse_proxy app:8080
    }
}
